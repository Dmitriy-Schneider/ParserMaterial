# Анализ Fuzzy Search - Поиск аналогов по составу

**Дата:** 2026-01-10
**Версия:** 1.0

---

## Суть функции

**Fuzzy Search** находит марки стали с **похожим химическим составом**.

### Как работает

```
Пользователь: ищет HARDOX 500 (C=0.28%, Cr=1.00%)
Настройки: толеранс 50%, макс. результатов 5
            ↓
Система: сравнивает химсостав со всеми 10,394 марками в БД
            ↓
Результат:
  1. AR500         (сходство 94%) - C=0.30%, Cr=1.20%
  2. Creusabro 8000 (сходство 91%) - C=0.28%, Cr=0.80%
  3. Hardox 450    (сходство 87%) - C=0.24%, Cr=1.20%
```

### Применение

- Поиск заменителей, когда нужной марки нет в наличии
- Определение аналогов для неизвестных марок
- Сравнение марок разных стандартов (AISI, DIN, GOST)

**Пример:** Марочник Stahlschluessel имеет такую функцию → профессиональный инструмент.

---

## Технический анализ

### Сложность: **НИЗКАЯ-СРЕДНЯЯ** ✓

| Компонент | Сложность | Причина |
|-----------|-----------|---------|
| Алгоритм | Низкая | Простое сравнение процентов |
| База данных | Низкая | Все данные уже есть |
| API | Низкая | Новый endpoint, не трогает старый код |
| Web UI | Средняя | Модальное окно + слайдер |
| Telegram Bot | Низкая | Простая команда `/fuzzy` |

### Выполнимость: **95/100** ✓

**Почему реально:**
- Все химические элементы уже в БД (C, Cr, Mo, V, W, Co, Ni, Mn, Si и т.д.)
- Не нужны внешние библиотеки
- Не нужно менять схему БД
- Простой алгоритм без AI/ML

**Алгоритм:**
```python
# Для каждого элемента:
разница = |значение1 - значение2| / max(значение1, значение2) * 100

# Если разница <= толеранс: элемент совпадает
# Если важные элементы совпадают: марки похожи
```

### Конфликты с существующим кодом: **ОЧЕНЬ НИЗКИЙ РИСК** ✓

**Почему нет конфликтов:**
- Новый файл `fuzzy_search.py` (не трогает старый код)
- Новый endpoint `/api/steels/fuzzy-search` (отдельно от `/api/steels`)
- Новая кнопка в Web UI (не меняет существующие фильтры)
- Новая команда `/fuzzy` в боте (не трогает `/search`)
- Нет изменений в БД
- Только чтение из БД (безопасно)

**Изменений в существующем коде: 0 строк**

---

## Реализация

### Фазы разработки

**Фаза 1: Backend (8 часов)**
- Создать `fuzzy_search.py` с алгоритмом сравнения
- Написать unit-тесты
- Проверить производительность (10,394 марок за <2 сек)

**Фаза 2: API (4 часа)**
- Добавить endpoint в `app.py`
- Валидация входных данных
- Integration-тесты

**Фаза 3: Web UI (8 часов)**
- Модальное окно с настройками
- Слайдер толеранса (10-100%)
- Таблица результатов с процентом сходства

**Фаза 4: Telegram Bot (4 часа)**
- Команда `/fuzzy HARDOX 500 50 5`
- Форматирование результатов (emoji-индикаторы)

**Фаза 5: Тестирование (4 часа)**
- End-to-end тесты
- Исправление багов

**Итого: 28 часов (3-5 дней)**

### Код (готовый пример)

```python
# fuzzy_search.py
class CompositionMatcher:
    def find_similar_grades(self, reference_composition, tolerance_percent=50, max_results=10):
        # 1. Получить все марки из БД
        # 2. Для каждой марки рассчитать сходство
        # 3. Отсортировать по сходству (убывание)
        # 4. Вернуть топ N результатов
```

---

## Сравнение с другими задачами

| Задача | Сложность | Время | Риск |
|--------|-----------|-------|------|
| **Fuzzy Search** | **Низкая-Средняя** | **28 часов** | **Низкий** |
| AI Search (текущий) | Высокая | 40 часов | Средний |
| Multi-Agent AI | Очень высокая | 150 часов | Высокий |
| Химические фильтры (текущие) | Средняя | 15 часов | Низкий |

**Fuzzy Search в 5 раз проще, чем AI Search.**

---

## Преимущества

✅ **Для пользователей:**
- Находит заменители материалов
- Работает с марками из AI Search (неизвестные БД)
- Как в профессиональных марочниках (Stahlschluessel)

✅ **Технически:**
- Простая реализация
- Нет зависимостей от внешних API
- Быстро работает (< 2 сек на 10,394 марок)
- Легко откатить (удалить новые файлы)

✅ **Бизнес:**
- Уникальная функция (редко где есть)
- Повышает ценность продукта
- Помогает в производстве (выбор аналогов)

---

## Риски и решения

| Риск | Вероятность | Решение |
|------|------------|---------|
| Медленная работа | Средняя | Кэширование + оптимизация SQL |
| Непонятен % толеранса | Низкая | Пресеты: Строгий (20%), Средний (50%), Свободный (80%) |
| Слишком много/мало результатов | Средняя | Автоподстройка порога, показывать количество |
| Диапазоны в составе ("3.75-4.50") | Низкая | Использовать среднее значение |

---

## Рекомендация: **ДЕЛАТЬ** ✓

### Почему?

1. **Низкая сложность** (3/10) - простой алгоритм
2. **Высокая выполнимость** (95/100) - все данные есть
3. **Нулевой риск конфликтов** (1/10) - независимая функция
4. **Высокая ценность** (8/10) - профессиональный инструмент
5. **Разумные усилия** (28 часов) - окупается

### План

**Шаг 1:** Разработать backend (алгоритм + API) - 12 часов
**Шаг 2:** Протестировать точность и скорость
**Шаг 3:** Если все ОК → добавить Web UI - 8 часов
**Шаг 4:** Если нужно → добавить в Telegram Bot - 4 часа

### Альтернативы

**MVP (минимум) - 12 часов:**
- Только backend + API
- Базовый Web UI (простая таблица без модального окна)

**Полная версия - 28 часов:**
- Backend + API
- Web UI с модальным окном и слайдером
- Telegram Bot интеграция

---

## Примеры использования

### Сценарий 1: Заменитель материала
```
Инженеру нужен: HARDOX 600 (нет в наличии)
↓
Fuzzy Search → находит:
  - AR600 (92% сходство) ✓ есть в наличии
  - Creusabro 4800 (88% сходство)
↓
Выбирает AR600 как замену
```

### Сценарий 2: Неизвестная марка из AI
```
Пользователь: /search Bohler K340 (нет в БД)
AI: находит состав C=1.10%, Cr=8.30%, Mo=2.10%
↓
Пользователь: /fuzzy Bohler K340 30 5
Система: ищет похожие в БД
↓
Результат:
  - AISI D2 (89% сходство)
  - DIN 1.2379 (87% сходство)
  - JIS SKD11 (85% сходство)
```

### Сценарий 3: Сравнение стандартов
```
Есть марка по GOST, нужен аналог AISI
↓
Fuzzy Search → показывает похожие марки AISI
```

---

## Итог

| Параметр | Оценка |
|----------|--------|
| **Сложность** | 3/10 (низкая) |
| **Выполнимость** | 95/100 (очень высокая) |
| **Риск конфликтов** | 1/10 (практически нет) |
| **Ценность** | 8/10 (высокая) |
| **Усилия** | 28 часов (3-5 дней) |
| **ROI** | Отличный |

### Ключевые моменты

✅ Простой алгоритм - работает на математике
✅ Все данные есть - не нужны внешние источники
✅ Независимая функция - не ломает существующий код
✅ Профессиональная фича - как в Stahlschluessel
✅ Легко откатить - просто удалить новые файлы

**Рекомендация:** Начать с backend (12 часов) → протестировать → решить про UI.
