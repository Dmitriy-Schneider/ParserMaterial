# –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ Telegram –±–æ—Ç

## –î–∞—Ç–∞: 2026-01-08

## –í–æ–ø—Ä–æ—Å 1: AI Search —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–±–æ–µ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö?

### ‚úÖ –û–±—â–∏–π –≤—ã–≤–æ–¥: –î–ê, —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ AI Search

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   AI Search Process                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ó–∞–ø—Ä–æ—Å –æ—Ç Telegram/Web
         ‚Üì
    [Check Cache] ‚Üê –ë–î —Å timeout + WAL ‚úÖ
         ‚Üì
    –ö–µ—à –Ω–∞–π–¥–µ–Ω? ‚Üí –î–∞ ‚Üí –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
         ‚Üì –ù–µ—Ç
    [Perplexity API] ‚Üê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
         ‚Üì
    –ù–∞—à–µ–ª? ‚Üí –ù–µ—Ç ‚Üí [OpenAI GPT-4] ‚Üê Fallback
         ‚Üì –î–∞
    [Validate Composition] ‚Üê –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
         ‚Üì
    –í–∞–ª–∏–¥–Ω—ã–π? ‚Üí –ù–µ—Ç ‚Üí –í–µ—Ä–Ω—É—Ç—å None
         ‚Üì –î–∞
    [Save to Cache] ‚Üê –ë–î —Å timeout + WAL ‚úÖ
         ‚Üì
    –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º

#### 1. ‚úÖ –î–æ—Å—Ç—É–ø –∫ –ë–î (–∫–µ—à) –∑–∞—â–∏—â–µ–Ω

**–§–∞–π–ª:** `ai_search.py`
**–°—Ç—Ä–æ–∫–∏:** 555, 606, 630

```python
# –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î –∏—Å–ø–æ–ª—å–∑—É—é—Ç get_connection()
conn = get_connection()  # ‚Üê timeout=30.0 + WAL mode
```

**–ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç:**
- –ï—Å–ª–∏ Telegram —á–∏—Ç–∞–µ—Ç –∫–µ—à, –∞ Web –ø–∏—à–µ—Ç ‚Üí –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (WAL)
- –ï—Å–ª–∏ –æ–±–∞ –ø–∏—à—É—Ç –≤ –∫–µ—à –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –≤—Ç–æ—Ä–æ–π –∂–¥–µ—Ç 30 —Å–µ–∫
- –û—à–∏–±–∫–∞ "database is locked" ‚Üí –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞

#### 2. ‚ö†Ô∏è Race condition: –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–π –º–∞—Ä–∫–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
T=0s: Telegram –∏—â–µ—Ç "K888" ‚Üí –∫–µ—à –ø—É—Å—Ç ‚Üí –∏–¥–µ—Ç –≤ Perplexity
T=0.1s: Web –∏—â–µ—Ç "K888" ‚Üí –∫–µ—à –ø—É—Å—Ç ‚Üí –∏–¥–µ—Ç –≤ Perplexity
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–π–¥—É—Ç –≤ Perplexity API (–¥–≤–æ–π–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
- –û–±–∞ –ø–æ–ª—É—á–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø—Ä–æ–π–¥—É—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é
- –û–±–∞ –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à (–æ–¥–∏–Ω –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ)
- –í –∏—Ç–æ–≥–µ: –æ–±–∞ –≤–µ—Ä–Ω—É—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –ù–∏–∑–∫–∞—è
- –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –û–ß–ï–ù–¨ –ù–ò–ó–ö–ê–Ø (–Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å –æ–¥–Ω—É –º–∞—Ä–∫—É –≤ –æ–¥–Ω—É —Å–µ–∫—É–Ω–¥—É)
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –õ–∏—à–Ω–∏–π API call (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ü–µ–Ω—Ç–æ–≤)
- –î–∞–Ω–Ω—ã–µ: –ù–ï –ø–æ–≤—Ä–µ–∂–¥–∞—é—Ç—Å—è, –æ–±–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

#### 3. ‚úÖ Perplexity API calls - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ

**–í–∞–∂–Ω–æ:** Perplexity –∏ OpenAI API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- Telegram –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å Perplexity –¥–ª—è "K888"
- Web –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å Perplexity –¥–ª—è "D2"
- ‚úÖ –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

### –õ–æ–≥–∏–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `ai_search.py`, —Å—Ç—Ä–æ–∫–∏ 76-79

```python
# 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ (–±—ã—Å—Ç—Ä–æ, –∏–∑ –ë–î)
cached_result = self._get_from_cache(grade_name)
if cached_result:
    return cached_result  # ‚Üê –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Ç–æ–π –∂–µ –º–∞—Ä–∫–∏ ‚Üí –∏–∑ –∫–µ—à–∞ (< 0.1 —Å–µ–∫)
- –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å Perplexity –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ API calls

**TTL –∫–µ—à–∞:** 24 —á–∞—Å–∞ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ `.env` ‚Üí `AI_CACHE_TTL`)

### –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–§–∞–π–ª:** `ai_search.py`, —Å—Ç—Ä–æ–∫–∏ 110-122

```python
# Strict validation - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤
is_valid = self._validate_composition(result)

if not is_valid:
    # ‚ùå –ù–ï –∫–µ—à–∏—Ä—É–µ—Ç—Å—è, –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
    return None
else:
    # ‚úÖ –ö–µ—à–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
    self._save_to_cache(grade_name, result)
    return result
```

**–í–∞–∂–Ω–æ:**
- –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–µ—à
- –ï—Å–ª–∏ –Ω–µ—Ç —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ ‚Üí None (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ë–î)

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤

#### –°—Ü–µ–Ω–∞—Ä–∏–π A: Telegram + Web –∏—â—É—Ç —Ä–∞–∑–Ω—ã–µ –º–∞—Ä–∫–∏

```
Telegram ‚Üí "K888" ‚Üí Perplexity API (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
Web      ‚Üí "D2"   ‚Üí Perplexity API (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ OK
- –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –ë–î (—Ä–∞–∑–Ω—ã–µ –º–∞—Ä–∫–∏ ‚Üí —Ä–∞–∑–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–µ—à–µ)
- –û–±–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–µ—à –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (timeout –∑–∞—â–∏—â–∞–µ—Ç)

#### –°—Ü–µ–Ω–∞—Ä–∏–π B: Telegram + Web –∏—â—É—Ç –æ–¥–Ω—É –º–∞—Ä–∫—É (–≤–ø–µ—Ä–≤—ã–µ)

```
T=0s:   Telegram ‚Üí "K888" ‚Üí –∫–µ—à –ø—É—Å—Ç ‚Üí Perplexity API
T=0.1s: Web      ‚Üí "K888" ‚Üí –∫–µ—à –ø—É—Å—Ç ‚Üí Perplexity API
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ö†Ô∏è –î–≤–æ–π–Ω–æ–π API call, –Ω–æ –û–ö
- –û–±–∞ –ø–æ–ª—É—á–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç Perplexity
- –û–±–∞ –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à:
  - Telegram —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø–µ—Ä–≤—ã–º
  - Web –¥–æ–∂–¥–µ—Ç—Å—è (timeout=30s) –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç
- –û–±–∞ –≤–µ—Ä–Ω—É—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$0.01-0.02 –∑–∞ –¥–≤–æ–π–Ω–æ–π Perplexity call (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)

#### –°—Ü–µ–Ω–∞—Ä–∏–π C: Telegram + Web –∏—â—É—Ç –æ–¥–Ω—É –º–∞—Ä–∫—É (–∫–µ—à –µ—Å—Ç—å)

```
T=0s:   Telegram ‚Üí "K888" ‚Üí –∫–µ—à –Ω–∞–π–¥–µ–Ω ‚Üí –≤–µ—Ä–Ω—É—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
T=0.1s: Web      ‚Üí "K888" ‚Üí –∫–µ—à –Ω–∞–π–¥–µ–Ω ‚Üí –≤–µ—Ä–Ω—É—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ò–î–ï–ê–õ–¨–ù–û
- –û–±–∞ —á–∏—Ç–∞—é—Ç –∏–∑ –∫–µ—à–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, WAL mode)
- –ù–µ—Ç API calls
- –ë—ã—Å—Ç—Ä–æ (< 0.1 —Å–µ–∫)

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π in-memory lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–§–∞–π–ª:** `ai_search.py`

```python
import threading

class AISearch:
    def __init__(self, ...):
        # ...
        self._search_locks = {}  # grade_name -> Lock
        self._locks_mutex = threading.Lock()

    def search_steel(self, grade_name: str):
        # Check cache first
        cached = self._get_from_cache(grade_name)
        if cached:
            return cached

        # Acquire lock for this specific grade
        with self._locks_mutex:
            if grade_name not in self._search_locks:
                self._search_locks[grade_name] = threading.Lock()
            lock = self._search_locks[grade_name]

        # Only one thread per grade will call Perplexity
        with lock:
            # Re-check cache (another thread might have filled it)
            cached = self._get_from_cache(grade_name)
            if cached:
                return cached

            # Call Perplexity/OpenAI...
            result = self._search_with_perplexity(grade_name)
            # ...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ API calls –¥–ª—è –æ–¥–Ω–æ–π –º–∞—Ä–∫–∏
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ –∂–¥–µ—Ç –ø–µ—Ä–≤–æ–≥–æ –∏ –±–µ—Ä–µ—Ç –∏–∑ –∫–µ—à–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∫–æ–¥–∞
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ (Flask)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü° –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –æ—á–µ–Ω—å –Ω–∏–∑–∫–∞—è)

## –í–æ–ø—Ä–æ—Å 2: Telegram –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4 mini –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º—ã?

### ‚úÖ –û—Ç–≤–µ—Ç: –î–ê, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GPT-4o-mini

### Context Analyzer –≤ Telegram Bot

**–§–∞–π–ª:** `telegram_bot/context_analyzer.py`
**–ú–æ–¥–µ–ª—å:** `gpt-4o-mini` (—Å—Ç—Ä–æ–∫–∞ 22)

```python
class ContextAnalyzer:
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key or os.getenv('OPENAI_API_KEY')
        self.model = 'gpt-4o-mini'  # ‚Üê GPT-4 mini –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ inference
        self.enabled = bool(self.api_key)
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤ Telegram: "–Ω–∞–π–¥–∏ bohler k340"
         ‚Üì
    [Context Analyzer] ‚Üê GPT-4o-mini
         ‚Üì
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç: intent="search", grade="bohler k340"
         ‚Üì
    [Search Handler] ‚Üí API /api/steels?grade=bohler k340&ai=true
         ‚Üì
    –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### –ü—Ä–∏–º–µ—Ä—ã –∞–Ω–∞–ª–∏–∑–∞

**–í—Ö–æ–¥–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
"–Ω–∞–π–¥–∏ 420"           ‚Üí intent: "search", grade: "420"
"–∞–Ω–∞–ª–æ–≥–∏ D2"          ‚Üí intent: "analogues", grade: "D2"
"—á—Ç–æ —Ç–∞–∫–æ–µ K888"      ‚Üí intent: "search", grade: "K888"
"—Å–∫–æ–ª—å–∫–æ –º–∞—Ä–æ–∫ –≤ –±–∞–∑–µ" ‚Üí intent: "stats"
"–ø–æ–º–æ—â—å"              ‚Üí intent: "help"
"—Ö–∏–º —Å–æ—Å—Ç–∞–≤ 1.2379"   ‚Üí intent: "search", grade: "1.2379"
```

### –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT-4o-mini

**–§–∞–π–ª:** `telegram_bot/context_analyzer.py`, —Å—Ç—Ä–æ–∫–∏ 48-74

```python
prompt = f"""Analyze this user message and determine their intent.

User message: "{message_text}"

Possible intents:
1. "search" - user wants to search for a steel grade
2. "analogues" - user wants to find equivalent grades
3. "stats" - user wants database statistics
4. "help" - user needs help
5. "unknown" - cannot determine intent

Return ONLY valid JSON:
{
    "intent": "search|analogues|stats|help|unknown",
    "grade": "extracted grade name or null",
    "confidence": 0.0-1.0
}
"""
```

### Fallback –º–µ—Ö–∞–Ω–∏–∑–º

–ï—Å–ª–∏ GPT-4o-mini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ OPENAI_API_KEY –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

**–§–∞–π–ª:** `telegram_bot/context_analyzer.py`, —Å—Ç—Ä–æ–∫–∏ 112-160

```python
def _simple_analysis(self, message_text: str):
    """Fallback: simple keyword-based analysis"""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    if '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' in message_lower or 'stats' in message_lower:
        return {'intent': 'stats', ...}

    if '–ø–æ–º–æ—â—å' in message_lower or 'help' in message_lower:
        return {'intent': 'help', ...}

    if '–∞–Ω–∞–ª–æ–≥' in message_lower:
        return {'intent': 'analogues', ...}

    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–æ–∏—Å–∫
    return {'intent': 'search', 'grade': message_text, ...}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ GPT-4o-mini

1. **–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
   - "—á—Ç–æ —Ç–∞–∫–æ–µ K888" ‚Üí –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –ø–æ–∏—Å–∫ –º–∞—Ä–∫–∏ K888
   - "–Ω–∞–π–¥–∏ –º–Ω–µ —Ö–∏–º —Å–æ—Å—Ç–∞–≤ D2" ‚Üí intent: search, grade: D2

2. **–ì–∏–±–∫–æ—Å—Ç—å:**
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–ø–µ—á–∞—Ç–∫–∞–º–∏
   - –ü–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã
   - –†—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏

3. **–°–∫–æ—Ä–æ—Å—Ç—å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å:**
   - GPT-4o-mini –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π (< 1 —Å–µ–∫)
   - –û—á–µ–Ω—å –¥–µ—à–µ–≤—ã–π (~$0.000001 –∑–∞ –∑–∞–ø—Ä–æ—Å)

### –§–ª–æ—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª:** `telegram_bot/handlers/search.py`, —Å—Ç—Ä–æ–∫–∏ 29-68

```python
async def handle_text_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text = update.message.text.strip()

    # Analyze intent using GPT-4o-mini
    analyzer = get_context_analyzer()
    analysis = analyzer.analyze_message(message_text)

    intent = analysis.get('intent', 'search')
    grade = analysis.get('grade')

    # Route to appropriate handler
    if intent == 'stats':
        await stats.stats_command(update, context)
    elif intent == 'help':
        await help_command.help_command(update, context)
    elif intent == 'analogues' and grade:
        await analogues.analogues_command(update, context)
    else:
        # Default: search
        await perform_search(update, grade or message_text)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–¢—Ä–µ–±—É–µ—Ç—Å—è –≤ `.env`:**
```env
OPENAI_API_KEY=your_openai_key_here
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:**
- –ï—Å–ª–∏ –∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback (keyword matching)
- Context analyzer —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Perplexity API

## –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | API | –ú–æ–¥–µ–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | Fallback |
|-----------|-----|--------|------------|----------|
| **AI Search (Perplexity)** | Perplexity API | sonar-pro | –ü–æ–∏—Å–∫ –º–∞—Ä–æ–∫ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º | OpenAI GPT-4 |
| **AI Search (OpenAI)** | OpenAI API | GPT-4 | Fallback –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ä–æ–∫ | –ù–µ—Ç (–≤–µ—Ä–Ω–µ—Ç None) |
| **Telegram Context** | OpenAI API | GPT-4o-mini | –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | Keyword matching |
| **PDF Extraction** | OpenAI API | GPT-4o-mini | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –∏–∑ PDF | Regex patterns |

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ

1. **–ë–î –¥–æ—Å—Ç—É–ø:** timeout=30s + WAL mode
2. **AI –∫–µ—à:** read/write —á–µ—Ä–µ–∑ get_connection() —Å –∑–∞—â–∏—Ç–æ–π
3. **Perplexity API:** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. **Context Analyzer:** stateless, –±–µ–∑ –ë–î –¥–æ—Å—Ç—É–ø–∞

### ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **In-memory lock** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω—ã—Ö API calls (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
2. **Rate limiting** –¥–ª—è AI –∑–∞–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –±—É–¥–µ—Ç –º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
3. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** –∑–∞–ø—Ä–æ—Å–æ–≤ (Telegram vs Web)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–î–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ (< 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**
- ‚úÖ –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞**
- ‚úÖ –í—Å–µ –∑–∞—â–∏—â–µ–Ω–æ –æ—Ç race conditions
- ‚úÖ –î–≤–æ–π–Ω—ã–µ API calls –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–∏

**–î–ª—è –±—É–¥—É—â–µ–≥–æ (> 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**
- –î–æ–±–∞–≤–∏—Ç—å in-memory locking
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å rate limiting
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API calls –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: [test_concurrent_ai.py](test_concurrent_ai.py)

```bash
python test_concurrent_ai.py
```

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
1. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –æ–¥–Ω–æ–π –º–∞—Ä–∫–∏ (Telegram + Web)
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–∞–∑–Ω—ã—Ö –º–∞—Ä–æ–∫ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
3. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ –∫–µ—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### ‚úÖ AI Search –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ó–∞—â–∏—â–µ–Ω–∞ (timeout + WAL)
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å:** ‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–†–∏—Å–∫–∏:** üü° –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (—Ä–µ–¥–∫–∏–µ –¥–≤–æ–π–Ω—ã–µ API calls)

### ‚úÖ Telegram Bot - GPT-4o-mini

- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** ‚úÖ –î–∞ (`gpt-4o-mini`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Fallback:** ‚úÖ Keyword matching –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ API
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** üí∞ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è (~$0.000001 –∑–∞ –∑–∞–ø—Ä–æ—Å)

### üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ Telegram –±–æ—Ç–∞ –∏ Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!**
