# ะััะตั ะพะฑ ะฐััะธัะตะบัััะต ัะธััะตะผั ะธ ะธะฝัะตะณัะฐัะธะธ ะบะพะผะฟะพะฝะตะฝัะพะฒ

## ะะฐัะฐ ะฟัะพะฒะตัะบะธ: 2026-01-08

## โ ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ (ะะะะะะะฌะะะฏ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ะะะะะะฏ ะะะะ ะะะะะซะฅ                          โ
โ              database/steel_database.db (SQLite)                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ (ะตะดะธะฝััะฒะตะฝะฝะฐั ัะพัะบะฐ ะดะพัััะฟะฐ)
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     FLASK API (app.py)                           โ
โ                  http://localhost:5001                           โ
โ                                                                  โ
โ  Endpoints:                                                      โ
โ  โข GET  /api/steels          - ะฟะพะธัะบ ะผะฐัะพะบ (+ AI fallback)      โ
โ  โข POST /api/steels/add      - ะดะพะฑะฐะฒะปะตะฝะธะต ะผะฐัะบะธ                 โ
โ  โข POST /api/steels/delete   - ัะดะฐะปะตะฝะธะต ะผะฐัะบะธ                   โ
โ  โข GET  /api/steels/ai-search - ะฟััะผะพะน AI ะฟะพะธัะบ                 โ
โ  โข GET  /api/stats           - ััะฐัะธััะธะบะฐ ะะ                    โ
โ                                                                  โ
โ  ะะพะดัะปะธ:                                                         โ
โ  โข ai_search.py         - Perplexity/OpenAI ะธะฝัะตะณัะฐัะธั          โ
โ  โข database_schema.py   - ัะฐะฑะพัะฐ ั ะะ                           โ
โ  โข config.py            - ะบะพะฝัะธะณััะฐัะธั                          โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ                       โ
                 โ                       โ
                 โ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ   TELEGRAM BOT         โ  โ   WEB ะะะขะะะคะะะก        โ
    โ   (ะบะปะธะตะฝั API)         โ  โ   (ะบะปะธะตะฝั API)         โ
    โ                        โ  โ                        โ
    โ โข ะะ ะธะผะตะตั ะดะพัััะฟะฐ ะบ ะะโ  โ โข ะะ ะธะผะตะตั ะดะพัััะฟะฐ ะบ ะะโ
    โ โข ะัะต ัะตัะตะท API        โ  โ โข ะัะต ัะตัะตะท API        โ
    โ โข Port: Telegram       โ  โ โข Port: 5001           โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โ ะัะพะฒะตัะบะฐ ะธะฝัะตะณัะฐัะธะธ

### 1. ะะฐะทะฐ ะดะฐะฝะฝัั
- **ะััั:** `database/steel_database.db`
- **ะะฒะธะถะพะบ:** SQLite
- **ะะพัััะฟ:** ะขะพะปัะบะพ ัะตัะตะท Flask API (app.py)
- **ะขะฐะฑะปะธัั:**
  - `steel_grades` - ะพัะฝะพะฒะฝะฐั ัะฐะฑะปะธัะฐ ะผะฐัะพะบ ััะฐะปะธ
  - `ai_searches` - ะบะตั AI ะทะฐะฟัะพัะพะฒ

### 2. Flask API (app.py)
- **URL:** `http://localhost:5001` (ะฟะพ ัะผะพะปัะฐะฝะธั)
- **ะะพะฝัะธะณััะฐัะธั:** `PARSERSTEEL_API_URL` ะฒ `.env`
- **ะะพะดัะปะธ:**
  - `ai_search.py` - AI ะฟะพะธัะบ ัะตัะตะท Perplexity/OpenAI
  - `database_schema.py` - ะดะพัััะฟ ะบ ะะ ัะตัะตะท `get_connection()`
  - `config.py` - ะฝะฐัััะพะนะบะธ ะะ (`DB_FILE = database/steel_database.db`)

**ะะฐะถะฝัะต endpoint'ั:**
```python
GET  /api/steels?grade=K888&ai=true  # ะะพะธัะบ ั AI fallback
POST /api/steels/add                  # ะะพะฑะฐะฒะธัั ะผะฐัะบั ะฒ ะะ
POST /api/steels/delete               # ะฃะดะฐะปะธัั ะผะฐัะบั ะธะท ะะ
GET  /api/steels/ai-search?grade=K888 # ะััะผะพะน AI ะฟะพะธัะบ
```

### 3. Telegram Bot
- **ะะพะฝัะธะณััะฐัะธั:** `telegram_bot/config.py`
- **API URL:** ะะตัะตััั ะธะท `.env` โ `PARSERSTEEL_API_URL` (default: `http://localhost:5001`)
- **Endpoints ะธัะฟะพะปัะทัะตะผัะต:**
  ```python
  SEARCH_ENDPOINT = f"{API_BASE_URL}/api/steels"
  AI_SEARCH_ENDPOINT = f"{API_BASE_URL}/api/steels/ai-search"
  STATS_ENDPOINT = f"{API_BASE_URL}/api/stats"
  ```
- **ะััะผะพะน ะดะพัััะฟ ะบ ะะ:** โ ะะะข (ะฟัะพะฒะตัะตะฝะพ ัะตัะตะท grep)
- **ะะพะดัะปะธ:**
  - `handlers/search.py` - ะพะฑัะฐะฑะพััะธะบ ะฟะพะธัะบะฐ ัะตัะตะท API
  - `handlers/analogues.py` - ะฟะพะธัะบ ะฐะฝะฐะปะพะณะพะฒ ัะตัะตะท API
  - `context_analyzer.py` - ะฐะฝะฐะปะธะท ะฝะฐะผะตัะตะฝะธะน ะฟะพะปัะทะพะฒะฐัะตะปั (GPT-4 mini)

### 4. AI Search ะผะพะดัะปั (ai_search.py)
- **ะัะฟะพะปัะทัะตััั:** Flask API (app.py)
- **ะัะธะพัะธัะตั:** Perplexity โ OpenAI (fallback)
- **ะะตัะธัะพะฒะฐะฝะธะต:** ะ ัะฐะฑะปะธัะต `ai_searches` (TTL: 24 ัะฐัะฐ)
- **ะฃะปัััะตะฝะธั:**
  - โ ะะฑัะทะฐัะตะปัะฝัะน ัะธะผะธัะตัะบะธะน ัะพััะฐะฒ
  - โ ะะทะฒะปะตัะตะฝะธะต source_url โ link
  - โ Manufacturer + Country
  - โ ะะฐะปะธะดะฐัะธั ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ

## โ ะัะพะฒะตัะบะฐ: ะฝะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ะปะพะณะธะบะธ

### ะะพะธัะบ ะผะฐัะพะบ ััะฐะปะธ
- โ **ะะ ะดัะฑะปะธััะตััั**
- ะะดะธะฝััะฒะตะฝะฝะฐั ัะตะฐะปะธะทะฐัะธั: `app.py` โ `/api/steels`
- Telegram Bot ะฒัะทัะฒะฐะตั ััะพั endpoint

### AI ะฟะพะธัะบ
- โ **ะะ ะดัะฑะปะธััะตััั**
- ะะดะธะฝััะฒะตะฝะฝะฐั ัะตะฐะปะธะทะฐัะธั: `ai_search.py` โ `AISearch.search_steel()`
- Flask API ะธะผะฟะพััะธััะตั: `from ai_search import get_ai_search`
- Telegram Bot ะฝะต ะธะผะตะตั ะฟััะผะพะณะพ ะดะพัััะฟะฐ ะบ `ai_search.py`

### ะะพัััะฟ ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
- โ **ะะ ะดัะฑะปะธััะตััั**
- ะะดะธะฝััะฒะตะฝะฝะฐั ัะพัะบะฐ ะดะพัััะฟะฐ: `database_schema.py` โ `get_connection()`
- Flask API ะธัะฟะพะปัะทัะตั: `from database_schema import get_connection`
- Telegram Bot ะะ ะธะผะฟะพััะธััะตั `database_schema`

## โ๏ธ ะะพัะตะฝัะธะฐะปัะฝัะต ะฟัะพะฑะปะตะผั ั ะพะดะฝะพะฒัะตะผะตะฝะฝัะผะธ ะทะฐะฟัะพัะฐะผะธ

### SQLite ะธ ะบะพะฝะบััะตะฝัะฝัะน ะดะพัััะฟ

SQLite ะธะผะตะตั ะพะณัะฐะฝะธัะตะฝะธั ะฟัะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพะน ะทะฐะฟะธัะธ ะธะท ะฝะตัะบะพะปัะบะธั ะฟัะพัะตััะพะฒ:
- โ ะะฝะพะถะตััะฒะตะฝะฝะพะต ััะตะฝะธะต: OK
- โ๏ธ ะะดะฝะพะฒัะตะผะตะฝะฝะฐั ะทะฐะฟะธัั: ะะะะะะะะะะ

**ะขะตะบััะตะต ัะพััะพัะฝะธะต:**
```python
# database_schema.py
def get_connection():
    return sqlite3.connect(config.DB_FILE)
```

**ะัะพะฑะปะตะผะฐ:** ะะตั ะฝะฐัััะพะตะฝะฝะพะณะพ timeout - ะผะพะถะตั ะฑััั `sqlite3.OperationalError: database is locked`

### ะะตะบะพะผะตะฝะดะฐัะธะธ ะดะปั ะทะฐัะธัั ะพั ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะฟัะพัะพะฒ

#### 1. ะะพะฑะฐะฒะธัั timeout ะฒ get_connection()

**ะคะฐะนะป:** `database_schema.py`

```python
def get_connection():
    """Get database connection with timeout for concurrent access"""
    return sqlite3.connect(config.DB_FILE, timeout=30.0)
```

**ะัะตะธะผััะตััะฒะฐ:**
- ะะถะธะดะฐะฝะธะต ะดะพ 30 ัะตะบัะฝะด ะฟัะธ ะฑะปะพะบะธัะพะฒะบะต
- ะะทะฑะตะถะฐะฝะธะต ะพัะธะฑะบะธ "database is locked"
- ะะพะดะดะตัะถะบะฐ ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะฟัะพัะพะฒ ะพั Telegram ะธ Web

#### 2. ะะบะปััะธัั WAL ัะตะถะธะผ (Write-Ahead Logging)

**ะคะฐะนะป:** `database_schema.py`

```python
def get_connection():
    """Get database connection with WAL mode for better concurrency"""
    conn = sqlite3.connect(config.DB_FILE, timeout=30.0)
    conn.execute('PRAGMA journal_mode=WAL')  # ะฃะปัััะตะฝะฝะฐั ะบะพะฝะบััะตะฝัะฝะพััั
    return conn
```

**ะัะตะธะผััะตััะฒะฐ WAL ัะตะถะธะผะฐ:**
- โ ะงะธัะฐัะตะปะธ ะฝะต ะฑะปะพะบะธัััั ะฟะธัะฐัะตะปะตะน
- โ ะะธัะฐัะตะปะธ ะฝะต ะฑะปะพะบะธัััั ัะธัะฐัะตะปะตะน
- โ ะะดะธะฝ ะฟะธัะฐัะตะปั ะผะพะถะตั ัะฐะฑะพัะฐัั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ั ะผะฝะพะถะตััะฒะพะผ ัะธัะฐัะตะปะตะน
- โ๏ธ ะกะพะทะดะฐะตั ะดะพะฟะพะปะฝะธัะตะปัะฝัะต ัะฐะนะปั: `*.db-wal`, `*.db-shm`

#### 3. ะัะฟะพะปัะทะพะฒะฐัั connection pooling (ะพะฟัะธะพะฝะฐะปัะฝะพ)

ะะปั ะฒััะพะบะพะฝะฐะณััะถะตะฝะฝัั ัะธััะตะผ ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ะฟัะป ัะพะตะดะธะฝะตะฝะธะน, ะฝะพ ะดะปั ัะตะบััะตะน ะฐััะธัะตะบัััั (Telegram Bot + Web) **timeout + WAL ะดะพััะฐัะพัะฝะพ**.

## ๐ ะกัะตะฝะฐัะธะธ ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะฟัะพัะพะฒ

### ะกัะตะฝะฐัะธะน 1: Telegram ะฟะพะธัะบ + Web ะฟะพะธัะบ
```
Telegram Bot โ API /api/steels?grade=K888&ai=false โ ะะ (READ)
Web Client   โ API /api/steels?grade=D2&ai=false   โ ะะ (READ)
```
**ะกัะฐััั:** โ OK (ะผะฝะพะถะตััะฒะตะฝะฝะพะต ััะตะฝะธะต)

### ะกัะตะฝะฐัะธะน 2: Telegram ะดะพะฑะฐะฒะปะตะฝะธะต + Web ะฟะพะธัะบ
```
Telegram Bot โ API /api/steels/add โ ะะ (WRITE)
Web Client   โ API /api/steels     โ ะะ (READ)
```
**ะกัะฐััั:**
- ะะตะท WAL: โ๏ธ READ ะฑัะดะตั ะถะดะฐัั WRITE
- ะก WAL: โ OK (ะบะพะฝะบััะตะฝัะฝัะน ะดะพัััะฟ)

### ะกัะตะฝะฐัะธะน 3: Telegram ะดะพะฑะฐะฒะปะตะฝะธะต + Web ะดะพะฑะฐะฒะปะตะฝะธะต
```
Telegram Bot โ API /api/steels/add โ ะะ (WRITE)
Web Client   โ API /api/steels/add โ ะะ (WRITE)
```
**ะกัะฐััั:**
- โ๏ธ ะัะพัะพะน ะทะฐะฟัะพั ะฑัะดะตั ะถะดะฐัั ะฟะตัะฒะพะณะพ (ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะฐั ะทะฐะฟะธัั)
- ะก timeout: ะถะดะตั ะดะพ 30 ัะตะบัะฝะด
- ะะตะท timeout: ะผะพะถะตั ัะฟะฐััั ั "database is locked"

## ๐ง ะะตะบะพะผะตะฝะดัะตะผัะต ะธะทะผะตะฝะตะฝะธั

### ะัะธัะธัะตัะบะธะต (ะดะพะปะถะฝั ะฑััั ัะดะตะปะฐะฝั)

1. **ะะพะฑะฐะฒะธัั timeout ะฒ database_schema.py**
   ```python
   def get_connection():
       return sqlite3.connect(config.DB_FILE, timeout=30.0)
   ```

### ะะฐััะพััะตะปัะฝะพ ัะตะบะพะผะตะฝะดัะตััั

2. **ะะบะปััะธัั WAL ัะตะถะธะผ ะดะปั ะปัััะตะน ะบะพะฝะบััะตะฝัะฝะพััะธ**
   ```python
   def get_connection():
       conn = sqlite3.connect(config.DB_FILE, timeout=30.0)
       conn.execute('PRAGMA journal_mode=WAL')
       return conn
   ```

### ะะฟัะธะพะฝะฐะปัะฝะพ (ะดะปั ะฑัะดััะตะณะพ)

3. **ะะพะณะธัะพะฒะฐะฝะธะต ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะพะฒ**
4. **ะะตััะธะบะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั API**
5. **Rate limiting ะดะปั AI ะทะฐะฟัะพัะพะฒ**

## โ ะะฐะบะปััะตะฝะธะต

### ะขะตะบััะตะต ัะพััะพัะฝะธะต
- โ ะะดะธะฝะฐั ะฑะฐะทะฐ ะดะฐะฝะฝัั
- โ ะะดะธะฝะฐั ัะพัะบะฐ ะดะพัััะฟะฐ (Flask API)
- โ ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ะปะพะณะธะบะธ
- โ Telegram Bot ะบะพััะตะบัะฝะพ ะธัะฟะพะปัะทัะตั API
- โ AI Search ะผะพะดัะปั ะฝะต ะดัะฑะปะธััะตััั
- โ๏ธ ะะตั ะทะฐัะธัั ะพั concurrent access (ะฝัะถะตะฝ timeout)

### ะงัะพ ัะฐะฑะพัะฐะตั
- ะะดะธะฝะพัะฝัะต ะทะฐะฟัะพัั
- ะะฝะพะถะตััะฒะตะฝะฝะพะต ััะตะฝะธะต
- AI ะฟะพะธัะบ ัะตัะตะท Perplexity/OpenAI
- ะะตัะธัะพะฒะฐะฝะธะต AI ัะตะทัะปััะฐัะพะฒ
- ะะพะฑะฐะฒะปะตะฝะธะต/ัะดะฐะปะตะฝะธะต ะผะฐัะพะบ ัะตัะตะท API

### ะงัะพ ะฝัะถะฝะพ ัะปัััะธัั
- ะะพะฑะฐะฒะธัั `timeout=30.0` ะฒ `get_connection()`
- ะะบะปััะธัั WAL ัะตะถะธะผ ะดะปั SQLite
- ะะฟัะธะพะฝะฐะปัะฝะพ: ะดะพะฑะฐะฒะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะพะฒ

### ะะธัะบะธ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน
- ะัะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพะน ะทะฐะฟะธัะธ ะพั Telegram ะธ Web โ ะพัะธะฑะบะฐ "database is locked"
- ะะตัะพััะฝะพััั: ะะะะะะฏ (ัะตะดะบะธะน ัะปััะฐะน)
- ะัะธัะธัะฝะพััั: ะกะะะะะฏะฏ (ะทะฐะฟัะพั ัะฟะฐะดะตั, ะฝะพ ะะ ะฝะต ะฟะพะฒัะตะดะธััั)

### ะะพัะปะต ะฒะฝะตัะตะฝะธั ะธะทะผะตะฝะตะฝะธะน
- โ ะะพะปะฝะฐั ะทะฐัะธัะฐ ะพั ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะฟัะพัะพะฒ
- โ Telegram ะธ Web ะผะพะณัั ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ
- โ ะงะธัะฐัะตะปะธ ะฝะต ะฑะปะพะบะธัััั ะฟะธัะฐัะตะปะตะน (WAL)
- โ ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะฝะฐะณััะทะบะต
