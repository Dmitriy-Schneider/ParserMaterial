# Глубокий анализ функции Similar / Fuzzy Search

## Дата анализа: 2026-02-13

---

## 1. Текущая реализация

### 1.1. Структура алгоритма (fuzzy_search.py)

```python
ELEMENTS = [
    'c', 'cr', 'ni', 'mo',      # Высокий приоритет (вес 3)
    'v', 'w', 'co', 'mn', 'si',  # Средний приоритет (вес 2)
    'cu', 'nb', 'n'              # Низкий приоритет (вес 1)
]
```

**Текущая логика:**
1. Для каждого элемента вычисляется процентное отклонение от эталона
2. Если отклонение > tolerance% → элемент считается "mismatched"
3. Если количество mismatched > max_mismatched_elements → марка отсеивается
4. Расчет similarity (0-100%) с весами элементов

### 1.2. Проблемы текущей реализации

#### Проблема 1: Плоская система приоритетов

**Текущее состояние:**
```python
if element in ['c', 'cr', 'ni', 'mo']:
    weight = 3  # Высокий приоритет
elif element in ['v', 'w', 'co', 'mn', 'si']:
    weight = 2  # Средний приоритет
else:
    weight = 1  # Низкий приоритет
```

**Проблема:** Одинаковые веса для ВСЕХ типов сталей!

**Пример проблемы:**
- Для **быстрорежущей стали** (HSS) W и V критически важны (твердость при нагреве)
- Для **нержавеющей стали** Cr и Ni критически важны (коррозионная стойкость)
- Для **холодноштамповой стали** C и Cr важны (износостойкость)

Текущий алгоритм НЕ различает эти случаи!

---

#### Проблема 2: Max Mismatched не учитывает значимость элемента

**Текущий код (count_mismatched_elements):**
```python
for element in self.ELEMENTS:
    is_match, diff_percent = self.calculate_element_similarity(...)
    if not is_match:
        mismatched_count += 1  # Просто +1 для ЛЮБОГО элемента
```

**Проблема:**
- Отклонение в Cu (малозначимый) = отклонение в C (критичный)
- Оба дают +1 к mismatched_count

**Пример для 1.2379 (X155CrVMo12-1):**
- Если tolerance=10%, max_mismatched=2
- Отклонение в C (1.55%) и Cr (12%) → 2 mismatched → ОТСЕИВАЕТСЯ
- Отклонение в Cu и N → 2 mismatched → ПРОХОДИТ
- **Но Cu и N не влияют на характер стали 1.2379!**

---

#### Проблема 3: Нет классификации типов сталей

Алгоритм НЕ определяет тип стали по химсоставу, хотя это возможно:

| Химический состав | Тип стали | Критичные элементы |
|-------------------|-----------|-------------------|
| C > 0.5%, Cr > 10% | Холодноштамповая | C, Cr, Mo, V |
| C > 0.5%, W > 5% | Быстрорежущая (HSS) | C, W, Mo, V, Co |
| Cr > 16%, Ni > 8% | Нержавеющая аустенитная | Cr, Ni, Mo |
| C < 0.1%, Cr > 12% | Нержавеющая ферритная | Cr |
| C > 0.3%, Cr 3-8%, Mo 1-3% | Горячештамповая | C, Cr, Mo, V |
| Mn > 10% | Высокомарганцовистая (Гадфильда) | C, Mn |
| W > 10%, Co > 5% | Твердый сплав на основе Co | W, Co, C |

---

## 2. Анализ идеи пользователя

### 2.1. Суть идеи

1. **Классифицировать стали по группам** на основе химсостава
2. **Для каждой группы определить приоритет элементов** (от критичных к малозначимым)
3. **Max Mismatched работает "умно":**
   - max_mismatched=1 → игнорирует ТОЛЬКО самый малозначимый элемент
   - max_mismatched=2 → игнорирует 2 самых малозначимых
   - И так далее...

### 2.2. Вердикт: ОТЛИЧНАЯ ИДЕЯ ✅

**Преимущества:**
1. **Интеллектуальный подбор** - учитывает металлургическую значимость элементов
2. **Соответствует реальному применению** - инженеры именно так думают
3. **Гибкость** - каждая группа имеет свою логику
4. **Масштабируемость** - легко добавить новые группы

**Потенциальные сложности:**
1. Необходимо правильно определить границы групп
2. Марки на границе классов могут неправильно классифицироваться
3. Некоторые фирменные марки имеют уникальный состав

---

## 3. Классификация сталей по химическому составу

### 3.1. Предлагаемые группы

#### Группа 1: Холодноштамповые (Cold Work Tool Steels)

**Характерный состав:**
- C: 0.5-2.5%
- Cr: 5-15%
- Mo: 0.3-1.5%
- V: 0.1-4.0%
- W: 0-2%

**Примеры марок:** 1.2379 (D2), 1.2363 (A2), Х12МФ, CPM 10V, K888 MATRIX

**Приоритет элементов (от критичного к малозначимому):**
1. **C** (углерод) - определяет твердость и износостойкость
2. **Cr** (хром) - карбидообразователь, износостойкость
3. **V** (ванадий) - мелкодисперсные карбиды VC, износостойкость
4. **Mo** (молибден) - прокаливаемость, карбидообразование
5. **W** (вольфрам) - твердость карбидов
6. **Nb** (ниобий) - **КРИТИЧЕН!** Образует NbC карбиды, существенно повышает износостойкость даже при малых добавках (0.1-0.5%)
7. **Mn** (марганец) - прокаливаемость
8. **Si** (кремний) - раскислитель
9. **Ni** (никель) - вязкость (не критичен для холодной штамповки)
10. **Co, Cu, N** - малозначимы

**Иерархия карбидообразующих элементов:** V > Nb > Mo > W > Cr > Mn

---

#### Группа 2: Горячештамповые (Hot Work Tool Steels)

**Характерный состав:**
- C: 0.25-0.55%
- Cr: 3-8%
- Mo: 1-3%
- V: 0.3-1.5%
- W: 0-5%

**Примеры марок:** 1.2343 (H11), 1.2344 (H13), 4Х5МФС, 5ХНМ

**Приоритет элементов:**
1. **Mo** (молибден) - теплостойкость, красностойкость (КРИТИЧЕН)
2. **Cr** (хром) - жаростойкость (КРИТИЧЕН)
3. **V** (ванадий) - стойкость к разупрочнению при T
4. **W** (вольфрам) - **КРИТИЧЕН!** Красностойкость, теплостойкость при T>400°C
5. **Ni** (никель) - **ВАЖЕН!** Ударная вязкость, критичен для 5ХНМ-типа сталей
6. **C** (углерод) - твердость (но ниже чем у холодноштамповых)
7. **Si** (кремний) - жаростойкость
8. **Co** (кобальт) - красностойкость (в некоторых марках)
9. **Mn, Cu, Nb, N** - малозначимы

**Примечание:** W и Ni часто недооценивают. W обеспечивает красностойкость при T>400°C (сохранение твердости). Ni критичен для ударных нагрузок (молоты, прессы).

---

#### Группа 3: Быстрорежущие (High Speed Steels - HSS)

**Характерный состав:**
- C: 0.7-1.5%
- W: 5-20% (или Mo: 3-10% для молибденовых)
- V: 1-5%
- Cr: 3-5%
- Co: 0-12%

**Примеры марок:** M2, M42, T1, Р6М5, Р18, ASP23, ASP2030

**Приоритет элементов:**
1. **W** (вольфрам) - красностойкость, определяет класс стали
2. **Mo** (молибден) - заменитель W, красностойкость
3. **V** (ванадий) - износостойкость режущей кромки
4. **Co** (кобальт) - красностойкость при высоких T
5. **C** (углерод) - твердость
6. **Cr** (хром) - прокаливаемость (стабильно 4%)
7. **Mn, Si, Ni, Cu, Nb, N** - малозначимы

---

#### Группа 4: Нержавеющие аустенитные (Austenitic Stainless)

**Характерный состав:**
- C: < 0.15%
- Cr: 16-26%
- Ni: 8-25%
- Mo: 0-7%

**Примеры марок:** AISI 304, 316L, 12Х18Н10Т, 1.4301, 1.4404

**Приоритет элементов:**
1. **Cr** (хром) - коррозионная стойкость, определяет класс
2. **Ni** (никель) - стабилизация аустенита
3. **Mo** (молибден) - стойкость к питтинговой коррозии
4. **N** (азот) - прочность, заменитель Ni
5. **C** (углерод) - минимизируется (межкристаллитная коррозия)
6. **Ti, Nb** (стабилизаторы) - предотвращение карбидообразования
7. **Mn, Si, Cu, Co** - малозначимы

---

#### Группа 5: Нержавеющие мартенситные (Martensitic Stainless)

**Характерный состав:**
- C: 0.1-1.2%
- Cr: 11-18%
- Ni: 0-2%
- Mo: 0-2%

**Примеры марок:** AISI 420, 440C, Х12МФ, 1.4034, 1.4125

**Приоритет элементов:**
1. **C** (углерод) - твердость, прочность
2. **Cr** (хром) - коррозионная стойкость
3. **Mo** (молибден) - прочность, коррозионная стойкость
4. **V** (ванадий) - износостойкость
5. **Ni** (никель) - вязкость
6. **Mn, Si, W, Cu, Nb, N** - малозначимы

---

#### Группа 6: Для пресс-форм пластмасс (Plastic Mold Steels)

**Характерный состав:**
- C: 0.25-0.55%
- Cr: 12-18% (для коррозионностойких) или 1-2% (для улучшенных)
- Mo: 0-1%
- Ni: 0-4%

**Примеры марок:**
- **Коррозионностойкие:** 1.2083 (420ESR), 1.2316, 40Х13
- **Улучшенные (без Cr-коррозионностойкости):** 1.2738 (40CrMnNiMo8-6-4), 1.2311 (40CrMnMo7), 1.2312 (40CrMnMoS8-6)
- **С высокой износостойкостью:** 1.2383 (X100CrMoV5-1)

**Переходная группа:** Инструментально-конструкционные стали (1.2738, 1.2311) сочетают характеристики конструкционных и инструментальных сталей

**Приоритет элементов:**
1. **Cr** (хром) - полируемость, коррозионная стойкость
2. **Mo** (молибден) - прочность
3. **C** (углерод) - твердость (ограничена для полируемости)
4. **Ni** (никель) - вязкость
5. **S** (сера) - обрабатываемость (в 1.2312)
6. **Mn, Si, V, W, Cu, Nb, N** - малозначимы

---

#### Группа 7: Конструкционные легированные (Alloy Structural Steels)

**Характерный состав:**
- C: 0.15-0.60%
- Cr: 0.5-3%
- Ni: 0-4%
- Mo: 0-0.5%

**Примеры марок:** 4140, 4340, 30ХН2МФА, 40Х, 42CrMo4

**Приоритет элементов:**
1. **C** (углерод) - прочность, твердость
2. **Cr** (хром) - прокаливаемость
3. **Ni** (никель) - вязкость
4. **Mo** (молибден) - прокаливаемость, прочность
5. **Mn** (марганец) - прокаливаемость
6. **V** (ванадий) - измельчение зерна
7. **Si, W, Cu, Nb, N** - малозначимы

---

#### Группа 8: Износостойкие (Wear Resistant / AR Steels)

**Характерный состав:**
- C: 0.15-0.35%
- Cr: 0.5-2%
- Mn: 0.5-2%
- Mo: 0-0.5%
- Ni: 0-1%
- B: часто присутствует (0.001-0.005%)

**Примеры марок:** HARDOX 400/450/500, AR400, AR500, Dillidur

**Приоритет элементов:**
1. **C** (углерод) - твердость, износостойкость
2. **Mn** (марганец) - прокаливаемость, твердость
3. **Cr** (хром) - прокаливаемость
4. **Mo** (молибден) - прокаливаемость
5. **Ni** (никель) - вязкость
6. **B** (бор) - прокаливаемость (если есть)
7. **Si, V, W, Cu, Nb, N** - малозначимы

---

#### Группа 9: Высокомарганцовистые (Hadfield / Mn-Steels)

**Характерный состав:**
- C: 0.9-1.4%
- Mn: 11-15%
- Cr: 0-2%
- Si: 0.3-1%

**Примеры марок:** Г13, 110Г13Л, X120Mn12, 1.3401

**Приоритет элементов:**
1. **Mn** (марганец) - определяет класс стали (аустенитная структура)
2. **C** (углерод) - твердость после наклепа
3. **Cr** (хром) - износостойкость
4. **Si, Ni, Mo, V, W, Cu, Nb, N** - малозначимы

---

#### Группа 10: Жаропрочные никелевые (Ni-Base Superalloys)

**Характерный состав:**
- Ni: > 40%
- Cr: 15-25%
- Co: 0-20%
- Mo: 0-10%
- W: 0-10%

**Примеры марок:** INCONEL 625, 718, Nimonic 80A, Hastelloy X

**Приоритет элементов:**
1. **Ni** (никель) - база сплава
2. **Cr** (хром) - жаростойкость
3. **Mo** (молибден) - жаропрочность
4. **Co** (кобальт) - жаропрочность
5. **W** (вольфрам) - жаропрочность
6. **Nb, Ti, Al** (упрочнители)
7. **C, Mn, Si, Cu** - малозначимы

---

## 4. Алгоритм определения группы стали

### 4.1. Дерево решений

```python
def classify_steel(composition: Dict) -> str:
    """Определение типа стали по химическому составу"""

    c = parse_value(composition.get('c'))
    cr = parse_value(composition.get('cr'))
    ni = parse_value(composition.get('ni'))
    mo = parse_value(composition.get('mo'))
    w = parse_value(composition.get('w'))
    mn = parse_value(composition.get('mn'))
    v = parse_value(composition.get('v'))
    co = parse_value(composition.get('co'))

    # Жаропрочные никелевые (Ni > 40%)
    if ni and ni > 40:
        return 'NICKEL_SUPERALLOY'

    # Высокомарганцовистые (Mn > 10%)
    if mn and mn > 10:
        return 'HADFIELD_MN_STEEL'

    # Быстрорежущие (W > 5% или Mo > 3% при C > 0.7%)
    if c and c > 0.7:
        if (w and w > 5) or (mo and mo > 3):
            return 'HSS_HIGH_SPEED'

    # Нержавеющие (Cr > 10%)
    if cr and cr > 10:
        # Аустенитные (Ni > 7%)
        if ni and ni > 7:
            return 'STAINLESS_AUSTENITIC'
        # Мартенситные (C > 0.1%)
        if c and c > 0.1:
            return 'STAINLESS_MARTENSITIC'
        # Ферритные
        return 'STAINLESS_FERRITIC'

    # Холодноштамповые (C > 0.5%, Cr 5-15%)
    if c and c > 0.5 and cr and 5 <= cr <= 15:
        return 'COLD_WORK_TOOL'

    # Горячештамповые (C 0.25-0.55%, Cr 3-8%, Mo > 1%)
    if c and 0.25 <= c <= 0.55 and cr and 3 <= cr <= 8 and mo and mo > 1:
        return 'HOT_WORK_TOOL'

    # Износостойкие (низкий C, средний Mn, часто B)
    if c and 0.15 <= c <= 0.35 and mn and mn > 0.8:
        if cr and cr < 3:
            return 'WEAR_RESISTANT'

    # Конструкционные легированные (по умолчанию для легированных)
    if cr and cr > 0.5:
        return 'ALLOY_STRUCTURAL'

    # Углеродистые (если ничего не подходит)
    return 'CARBON_STEEL'
```

---

## 5. Предлагаемый алгоритм Max Mismatched

### 5.1. Концепция "Умного Max Mismatched"

**Текущий алгоритм:**
```
mismatched_count > max_mismatched → ОТСЕЯТЬ
```
Все элементы равнозначны.

**Предлагаемый алгоритм:**
```
1. Определить тип стали по химсоставу
2. Получить список элементов в порядке убывания значимости для этого типа
3. При подсчете mismatched:
   - Первые N (max_mismatched) элементов с отклонением ИГНОРИРУЮТСЯ
   - Но только если это МАЛОЗНАЧИМЫЕ элементы для данного типа
4. Если хотя бы один КРИТИЧНЫЙ элемент выходит за tolerance → ОТСЕЯТЬ
```

### 5.2. Пример для холодноштамповой стали (1.2379)

**Приоритет элементов (от критичного к малозначимому):**
1. C, 2. Cr, 3. V, 4. Mo, 5. W, 6. Mn, 7. Si, 8. Ni, 9. Co, 10. Cu, 11. Nb, 12. N

**Допуск tolerance=10%, max_mismatched=2**

**Сценарий A: Отклонение в Cu и N**
```
Cu: отклонение 15% (> tolerance)
N: отклонение 12% (> tolerance)
→ mismatched = {Cu, N} = 2 элемента
→ Cu (позиция 10), N (позиция 12) = самые малозначимые
→ ПРОХОДИТ ✅
```

**Сценарий B: Отклонение в C и Cr**
```
C: отклонение 15% (> tolerance)
Cr: отклонение 12% (> tolerance)
→ mismatched = {C, Cr} = 2 элемента
→ C (позиция 1), Cr (позиция 2) = самые критичные
→ ОТСЕИВАЕТСЯ ❌
```

**Сценарий C: Отклонение в Cu, N и Si**
```
Cu: отклонение 15%
N: отклонение 12%
Si: отклонение 11%
→ mismatched = {Cu, N, Si} = 3 элемента
→ max_mismatched = 2 → превышено
→ ОТСЕИВАЕТСЯ ❌
```

---

### 5.3. Реализация "Smart Max Mismatched"

```python
class SteelGroup:
    """Группа стали с приоритетом элементов"""

    def __init__(self, name: str, element_priority: List[str]):
        """
        Args:
            name: Название группы (COLD_WORK_TOOL, HSS, etc.)
            element_priority: Список элементов от критичного к малозначимому
        """
        self.name = name
        self.element_priority = element_priority

    def get_element_rank(self, element: str) -> int:
        """
        Получить ранг элемента (0 = самый критичный)

        Returns:
            Позиция в списке или 999 если не найден
        """
        try:
            return self.element_priority.index(element)
        except ValueError:
            return 999  # Неизвестный элемент = малозначимый


# Определение групп (ИСПРАВЛЕНО на основе металлургического анализа)
STEEL_GROUPS = {
    'COLD_WORK_TOOL': SteelGroup('Холодноштамповая',
        ['c', 'cr', 'v', 'mo', 'w', 'nb', 'mn', 'si', 'ni', 'co', 'cu', 'n']),
        # Nb поднят выше - критичен для износостойкости (NbC карбиды)

    'HOT_WORK_TOOL': SteelGroup('Горячештамповая',
        ['mo', 'cr', 'v', 'w', 'ni', 'c', 'si', 'co', 'mn', 'cu', 'nb', 'n']),
        # W и Ni подняты - критичны для красностойкости и ударной вязкости

    'HSS_HIGH_SPEED': SteelGroup('Быстрорежущая',
        ['w', 'mo', 'v', 'co', 'c', 'cr', 'mn', 'si', 'ni', 'cu', 'nb', 'n']),

    'STAINLESS_AUSTENITIC': SteelGroup('Нержавеющая аустенитная',
        ['cr', 'ni', 'mo', 'n', 'c', 'nb', 'mn', 'si', 'cu', 'co', 'v', 'w']),

    'STAINLESS_MARTENSITIC': SteelGroup('Нержавеющая мартенситная',
        ['c', 'cr', 'mo', 'v', 'ni', 'mn', 'si', 'w', 'cu', 'nb', 'n', 'co']),

    'WEAR_RESISTANT': SteelGroup('Износостойкая',
        ['c', 'mn', 'cr', 'mo', 'ni', 'si', 'v', 'w', 'cu', 'nb', 'n', 'co']),

    'HADFIELD_MN_STEEL': SteelGroup('Высокомарганцовистая',
        ['mn', 'c', 'cr', 'si', 'ni', 'mo', 'v', 'w', 'cu', 'nb', 'n', 'co']),

    'NICKEL_SUPERALLOY': SteelGroup('Жаропрочная никелевая',
        ['ni', 'cr', 'mo', 'co', 'w', 'nb', 'c', 'mn', 'si', 'cu', 'v', 'n']),

    'ALLOY_STRUCTURAL': SteelGroup('Конструкционная легированная',
        ['c', 'cr', 'ni', 'mo', 'mn', 'v', 'si', 'w', 'cu', 'nb', 'n', 'co']),

    'CARBON_STEEL': SteelGroup('Углеродистая',
        ['c', 'mn', 'si', 'cr', 'ni', 'mo', 'v', 'w', 'cu', 'nb', 'n', 'co']),
}


def smart_count_mismatched(
    ref_composition: Dict,
    candidate_composition: Dict,
    tolerance_percent: float,
    max_mismatched: int,
    steel_group: SteelGroup
) -> tuple[bool, int, List[str]]:
    """
    Умный подсчет mismatched с учетом значимости элементов

    Returns:
        (passes_filter: bool, mismatched_count: int, mismatched_elements: List[str])
    """
    mismatched_elements = []

    for element in ELEMENTS:
        ref_val = parse_element_value(ref_composition.get(element))
        cand_val = parse_element_value(candidate_composition.get(element))

        # Пропускаем если оба отсутствуют или эталон отсутствует
        if ref_val is None:
            continue

        is_match, diff_percent = calculate_element_similarity(
            ref_val, cand_val, tolerance_percent
        )

        if not is_match:
            mismatched_elements.append(element)

    # Сортируем mismatched элементы по убыванию их значимости (ранг)
    # Чем выше ранг (число) - тем менее значим элемент
    mismatched_sorted = sorted(
        mismatched_elements,
        key=lambda e: steel_group.get_element_rank(e),
        reverse=True  # Сначала малозначимые
    )

    # Проверка: можем ли мы "простить" отклонения?
    # max_mismatched = сколько МАЛОЗНАЧИМЫХ элементов можем игнорировать

    if len(mismatched_sorted) <= max_mismatched:
        # Все mismatched - малозначимые, проходит фильтр
        passes = True
    else:
        # Проверяем: оставшиеся после "прощения" - критичные?
        # Берем первые (самые малозначимые) max_mismatched элементов
        forgiven = mismatched_sorted[:max_mismatched]
        remaining = mismatched_sorted[max_mismatched:]

        # Если остались элементы с низким рангом (критичные) - не проходит
        # Порог: элементы с рангом <= 3 считаем критичными
        critical_threshold = 3

        has_critical = any(
            steel_group.get_element_rank(e) <= critical_threshold
            for e in remaining
        )

        passes = not has_critical

    return (passes, len(mismatched_elements), mismatched_elements)
```

---

## 6. Альтернативные подходы

### 6.1. Альтернатива A: Взвешенный Max Mismatched

Вместо простого подсчета, считаем **взвешенную сумму** отклонений:

```python
def weighted_mismatched_score(
    mismatched_elements: List[str],
    steel_group: SteelGroup
) -> float:
    """
    Взвешенная оценка несовпадений

    Критичные элементы дают больший вклад в score
    """
    total_score = 0

    for element in mismatched_elements:
        rank = steel_group.get_element_rank(element)
        # Вес = 12 - rank (чем критичнее элемент, тем выше вес)
        weight = max(12 - rank, 1)
        total_score += weight

    return total_score

# Использование:
# max_mismatched_score = 10 (вместо max_mismatched_count = 2)
# Cu(rank=10) + N(rank=11) = 2 + 1 = 3 → ПРОХОДИТ
# C(rank=0) + Cr(rank=1) = 12 + 11 = 23 → НЕ ПРОХОДИТ
```

**Преимущества:**
- Более гранулярный контроль
- Не требует жесткой границы по количеству

**Недостатки:**
- Сложнее для понимания пользователем
- Нужно калибровать порог

---

### 6.2. Альтернатива B: Двухуровневый фильтр

```python
def two_level_filter(
    mismatched_elements: List[str],
    steel_group: SteelGroup,
    max_critical_mismatched: int = 0,  # Критичные элементы
    max_secondary_mismatched: int = 2,  # Второстепенные элементы
    max_minor_mismatched: int = 4       # Малозначимые элементы
) -> bool:
    """
    Двухуровневый фильтр:
    - Критичные (ранг 0-2): max_critical_mismatched
    - Второстепенные (ранг 3-6): max_secondary_mismatched
    - Малозначимые (ранг 7+): max_minor_mismatched
    """
    critical = sum(1 for e in mismatched_elements
                   if steel_group.get_element_rank(e) <= 2)
    secondary = sum(1 for e in mismatched_elements
                    if 3 <= steel_group.get_element_rank(e) <= 6)
    minor = sum(1 for e in mismatched_elements
                if steel_group.get_element_rank(e) >= 7)

    return (critical <= max_critical_mismatched and
            secondary <= max_secondary_mismatched and
            minor <= max_minor_mismatched)
```

**Преимущества:**
- Интуитивно понятно
- Явный контроль по категориям

**Недостатки:**
- Больше параметров для настройки

---

### 6.3. Альтернатива C: Машинное обучение (ML)

Обучить модель на парах "похожих" марок:

```python
# Пример признаков для ML:
features = [
    diff_c,      # Отклонение по C
    diff_cr,     # Отклонение по Cr
    diff_mo,     # Отклонение по Mo
    ...
    steel_group, # Тип стали (one-hot encoded)
]

# Целевая переменная: 0/1 (похожи / не похожи)
# Метод: Random Forest, XGBoost, или Neural Network
```

**Преимущества:**
- Автоматически находит оптимальные веса
- Может учитывать нелинейные зависимости

**Недостатки:**
- Требует размеченные данные (пары "похожих" марок)
- Черный ящик (сложно объяснить решение)
- Избыточно для текущей задачи

---

## 7. Рекомендуемый план внедрения

### 7.1. Фаза 1: Классификация сталей (1-2 дня)

1. Создать функцию `classify_steel(composition)`
2. Определить 10 групп сталей с граничными условиями
3. Протестировать на существующей БД (9,614 марок)
4. Убедиться что 90%+ марок корректно классифицируются

**Файлы для изменения:**
- `fuzzy_search.py` - добавить классификацию

---

### 7.2. Фаза 2: Приоритеты элементов (1 день)

1. Создать словарь `STEEL_GROUPS` с приоритетами
2. Добавить метод `get_element_rank()`
3. Валидировать приоритеты с металлургической литературой

**Файлы для изменения:**
- `fuzzy_search.py` - добавить группы и приоритеты

---

### 7.3. Фаза 3: Smart Max Mismatched (2-3 дня)

1. Реализовать `smart_count_mismatched()`
2. Интегрировать в `find_similar_grades()`
3. Добавить параметр для выбора режима (legacy / smart)
4. Обновить API endpoint `/api/steels/fuzzy-search`

**Файлы для изменения:**
- `fuzzy_search.py` - основная логика
- `app.py` - обновить endpoint
- `templates/index.html` - UI для выбора режима (опционально)

---

### 7.4. Фаза 4: Тестирование (1-2 дня)

1. Создать тестовые кейсы для каждой группы сталей
2. Сравнить результаты legacy vs smart алгоритма
3. Валидация с экспертом (металлургом)

**Тестовые марки:**
- 1.2379 (холодноштамповая)
- 1.2344 (горячештамповая)
- M2, ASP23 (быстрорежущие)
- AISI 304, 316L (нержавеющие)
- HARDOX 500 (износостойкие)
- Г13 (марганцовистая)

---

### 7.5. Фаза 5: Telegram Bot + Web (1 день)

1. Обновить Telegram Bot для использования smart алгоритма
2. Добавить индикацию типа стали в результатах
3. Обновить документацию

---

## 8. Вердикт и рекомендации

### 8.1. Оценка идеи пользователя

| Критерий | Оценка |
|----------|--------|
| **Техническая реализуемость** | ✅ Высокая |
| **Металлургическая корректность** | ✅ Высокая |
| **Улучшение качества подбора** | ✅ Значительное |
| **Сложность внедрения** | ⚠️ Средняя (5-7 дней) |
| **Риски** | ⚠️ Пограничные случаи классификации |

### 8.2. Рекомендация

**РЕКОМЕНДУЮ внедрение с модификациями:**

1. **Использовать гибридный подход:**
   - Smart Max Mismatched как основной метод
   - Legacy режим как fallback

2. **Добавить параметр "строгость":**
   - Строгий: только точные совпадения по критичным элементам
   - Стандартный: Smart Max Mismatched
   - Мягкий: Legacy (текущий)

3. **Отображать тип стали в UI:**
   - "Найдены марки типа: Холодноштамповая (COLD_WORK_TOOL)"
   - Помогает пользователю понять логику подбора

4. **Добавить объяснение в результаты:**
   - "Отклонения: Cu (+15%), N (+12%) - малозначимые элементы для данного типа стали"

### 8.3. Приоритет реализации

1. **Высокий:** Классификация сталей + Приоритеты элементов
2. **Средний:** Smart Max Mismatched
3. **Низкий:** ML-подход (для будущего)

---

## 9. Заключение

Идея пользователя о **классификации сталей и ранжировании элементов** является **металлургически корректной** и значительно улучшит качество подбора аналогов.

**Ключевые преимущества:**
- Учитывает реальную значимость химических элементов для каждого типа стали
- Предотвращает ложноотрицательные результаты (когда отсеиваются похожие марки из-за малозначимых элементов)
- Предотвращает ложноположительные результаты (когда проходят непохожие марки из-за совпадения малозначимых элементов)

**Рекомендуемый срок реализации:** 5-7 рабочих дней

**Готов к внедрению после утверждения плана!**

---

*Документ подготовлен: 13 февраля 2026 г.*
*Автор: Claude Code Analysis*
